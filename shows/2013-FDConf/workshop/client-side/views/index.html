<html>
<head>
	<link href="../css/reset.css" rel="Stylesheet" type="text/css" />
	<link href="../css/frontendconf.css" rel="Stylesheet" type="text/css" />
	<script src="../js/jquery/jquery.min.js" type="text/javascript"></script>
	<script src="../js/drawing-api.js" type="text/javascript"></script>
	<script src="../js/chat-api.js" type="text/javascript"></script>
</head>
<body>
	<div class="canvas-container">
		<canvas width="800px" height="600px"></canvas>
		<div class="painter-controls-container">
			<input class="lineWidth" type="range" min="1" max="20" step="1" value="1" />
			<br />
			<input class="color-picker" type="color" value="#000" />
		</div>
		<div class="loading">
		</div>
		<div class="chat-container">
			<div class="chat-messages">
			</div>
			<div>
				<input class="login-value" type="text" />
				<input class="login-button" type="button" value="Логин" />
			</div>
			<div>
				<input class="text-value" type="text" />
				<input class="text-button" type="button" value="Сообщение" />
			</div>
		</div>
	</div>
	<script type="text/javascript">
		var socket = (WebSocket && new WebSocket('ws://frontendconf.nodejitsu.com')) || (MozWebSocket && new MozWebSocket('ws://frontendconf.nodejitsu.com'));
		var painter = new window.PainterComponent($('.canvas-container'));
		// ws://frontendconf.nodejitsu.com
		// Сервер посылает два вида сообщений - image & draw следующего вида
		//		{
		//		message:"image",
		//		data :{
		//				"data:image/png;base64,iVBORw0KGg..."
		//			}
		//		}
		// draw
		//		{
		//		message:"image",
		//		data :{
		//				type: "line",
		//				x1: self._startX,
		//				y1: self._startY,
		//				x2: coords.x,
		//				y2: coords.y,
		//				width: self._lineWidth,
		//				color: self._color
		//			}
		//		}
		// TO DO
		// 1. передать объект data из месседжа image в painter.drawImage
		// 2. передать объект data из месседжа image в painter.draw
		// не забывайте JSON.parse - сообщение приходит в строковом виде!
		socket.onmessage = function (response) {
			var data = JSON.parse(response.data);
			switch (data.message) {
				case "image":
					painter.drawImage(data.data);
					break;
				case "draw":
					painter.draw(data.data);
					break;
			}
		};

		//
		painter.onDraw = function (data) {
//			Реализовать отправку данных на сервер вида
//			{
//				message: "draw",
//				data: data
//			}
//			Не забывайте JSON.stringify - отправлять нужно только строковые значения!
			socket.send(JSON.stringify({
				message: "draw",
				data: data
			}));
		};

		var chatSocket = (WebSocket && new WebSocket('ws://frontendconfchat.nodejitsu.com')) || (MozWebSocket && new MozWebSocket('ws://frontendconfchat.nodejitsu.com'));
		var chat = new window.ChatComponent($('.chat-container'));
		// ws://frontendconfchat.nodejitsu.com
		// Сервер посылает только один вид сообщений вида:
		//		{
		//		login:"anonymous15",
		//		text : "Hi all!"
		//		}
		// TO DO:передать пришедший объект в метод chat.addMessage (не забывайте JSON.parse - сообщение приходит в строковом виде!)
		chatSocket.onmessage = function (response) {
			var data = JSON.parse(response.data);
			chat.addMessage(data);
		};
		chat.loginChanged = function (value) {
			//			Реализовать отправку данных на сервер вида
			//			{
			//				type: "login",
			//				value: value
			//			}
			// Не забывайте JSON.stringify - отправлять нужно только строковые значения!
			chatSocket.send(JSON.stringify({
				type: 'login',
				value: value
			}));
		};
		chat.textChanged = function (value) {
			//			Реализовать отправку данных на сервер вида
			//			{
			//				type: "text",
			//				value: value
			//			}
			// Не забывайте JSON.stringify - отправлять нужно только строковые значения!
			chatSocket.send(JSON.stringify({
				type: 'text',
				value: value
			}));
		};
	</script>
</body>
</html>
